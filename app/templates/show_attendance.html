<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <title>Show Attendance Code</title>
</head>
<body>
    <header>
        <h1>Show Attendance Code</h1>
    </header>
    <div class="container">
        <div class="code-container">
            <p class="small-text">Current code:</p>
            <p id="attendanceCode" class="code">Loading...</p>
            <p id="countdown" class="small-text">Refreshing in <span id="timer">30</span> seconds</p>
            <button id="stopAttendanceButton" class="button">Stop Attendance</button>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.3.2/dist/socket.io.js"></script>
    <script>
        const socket = io.connect('http://' + document.domain + ':' + location.port + '/code');
        let countdownInterval;
        let currentTime;
        let nextUpdateTime;
        let remainingTime;

        socket.on('code_update', function(data) {
            const codeElement = document.getElementById('attendanceCode');
            codeElement.textContent = data.code;

            if (currentTime === undefined || nextUpdateTime === undefined) {
                // Initial setup
                currentTime = data.current_time;
                nextUpdateTime = data.next_update_time;
                remainingTime = nextUpdateTime - currentTime;

                // Display the remaining time as an integer (whole seconds)
                const timeElement = document.getElementById('timer');
                timeElement.textContent = Math.ceil(remainingTime);  // Use Math.ceil to avoid negative values

                // Start the countdown timer
                const updateCountdown = () => {
                    remainingTime -= 1;
                    timeElement.textContent = Math.ceil(remainingTime);  // Use Math.ceil to avoid negative values
                    if (remainingTime >= 0) {
                        countdownInterval = setTimeout(updateCountdown, 1000);
                    }
                };
                updateCountdown();
            } else {
                // Update the current and next update time
                currentTime = data.current_time;
                nextUpdateTime = data.next_update_time;
                remainingTime = nextUpdateTime - currentTime;

                if (remainingTime < 0) {
                    // Handle negative values by resetting the timer
                    remainingTime = 0;
                }
            }
        });

        document.getElementById('stopAttendanceButton').addEventListener('click', function() {
            fetch('/stop_attendance', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => console.log(data))
            .catch(error => console.error('Error stopping attendance: ' + error));
            window.location.href = '/verify_attendance';
        });

    </script>
</body>
</html>
